<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=yes">
    <title>2026 Winter Master (Game with HighScore)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #fdfdfd;
            --math-br: #e3f2fd; --math-ryu: #e0f2f1;
            --math-dw: #f3e5f5; --math-ws: #e8eaf6;
            --phys-sol: #fff3e0; --phys-br: #ffebee;
            --phys-yang: #e1f5fe;
            --algo-hc: #e8f5e9; --algo-os: #f1f8e9;
            --holiday: #fffde7;
            --now-line: #ff4d4d;
            --sunday-red: #d32f2f;
            --chk-hw: rgba(255, 0, 0, 0.4);
            --chk-rev: rgba(0, 0, 255, 0.3);
            --today-border: #ff0000;
        }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; overflow-x: hidden; }
        header { background: #222; color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.5rem; }
        .section { display: none; padding: 15px; box-sizing: border-box; }
        .section.active { display: block; }

        @media (min-width: 1024px) {
            #home-section.active {
                display: flex;
                gap: 20px;
                max-width: 1400px;
                margin: 0 auto;
                align-items: flex-start;
            }
            .main-content { flex: 1.2; }
            .side-content { flex: 0.8; position: sticky; top: 20px; }
        }

        .dashboard { background: white; border-radius: 15px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #eee; }
        .timeline-scroll-area { width: 100%; border: 1px solid #eee; border-radius: 8px; overflow: hidden; display: flex; background: white; }
        .time-column { width: 65px; background: #f8f9fa; border-right: 1px solid #eee; flex-shrink: 0; position: relative; height: 722px; }
        .time-label { position: absolute; width: 100%; text-align: center; font-size: 14px; font-weight: 700; color: #444; height: 38px; line-height: 38px; top: 0; }
        .timeline-container { position: relative; height: 722px; flex-grow: 1; background: white; background-image: linear-gradient(#eee 1px, transparent 1px); background-size: 100% 38px; }
        .now-indicator { position: absolute; left: 0; right: 0; height: 2px; background: var(--now-line); z-index: 20; display: none; pointer-events: none; }
        .ev, .cal-ev { position: absolute; border-radius: 4px; border-left: 2px solid rgba(0,0,0,0.1); z-index: 5; overflow: hidden; display: flex; flex-direction: column; word-break: keep-all; }
        .ev { left: 2px; right: 2px; padding: 4px; }
        .cal-ev { left: 1px; right: 1px; padding: 2px; }
        .half-left { right: 51% !important; }
        .half-right { left: 51% !important; }
        .split-check-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 1; pointer-events: none; }
        .hw-part, .rev-part { flex: 1; height: 100%; }
        .hw-part.active { background: var(--chk-hw); }
        .rev-part.active { background: var(--chk-rev); }
        .ev-content { position: relative; z-index: 2; pointer-events: none; width: 100%; }
        .ev b { font-size: clamp(12px, 1.4vw, 18px); line-height: 1.1; margin-bottom: 2px; display: block; }
        .ev span { font-size: clamp(10px, 1.1vw, 14px); font-weight: 700; opacity: 0.9; }
        .cal-ev b { font-size: clamp(9px, 1vw, 13px); line-height: 1.05; display: block; }
        .cal-ev span { font-size: clamp(8px, 0.8vw, 11px); display: block; margin-top: 1px; opacity: 0.8; }
        .calendar-wrapper { width: 100%; border-radius: 8px; overflow: hidden; }
        .grid-container { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; width: 100%; }
        .day-header { background: #f8f9fa; padding: 8px 0; text-align: center; font-weight: bold; }
        .day-cell { background: white; height: 350px; position: relative; border-right: 1px solid #eee; border-bottom: 1px solid #eee; box-sizing: border-box; }
        .day-num { padding: 6px; font-weight: bold; }
        .is-red { color: var(--sunday-red) !important; }
        .is-today { border: 3px solid var(--today-border) !important; z-index: 10; }
        .edit-controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #ddd; }
        .edit-btn { background: #444; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .edit-active .edit-btn { background: #ff4d4d; }
        .edit-active .cal-ev { cursor: pointer; }
        .math-br { background: var(--math-br); color: #0d47a1; }
        .math-ryu { background: var(--math-ryu); color: #00695c; }
        .math-dw { background: var(--math-dw); color: #4a148c; }
        .math-ws { background: var(--math-ws); color: #1a237e; }
        .phys-sol { background: var(--phys-sol); color: #e65100; }
        .phys-br { background: var(--phys-br); color: #b71c1c; }
        .phys-yang { background: var(--phys-yang); color: #01579b; }
        .algo-hc { background: var(--algo-hc); color: #1b5e20; }
        .algo-os { background: var(--algo-os); color: #33691e; }
        .hldy { background: var(--holiday); color: #854d0e; text-align: center; font-weight: bold; }
        .nav-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .menu-btn-large { background: #222; color: white; border: none; padding: 25px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1.4rem; text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .back-btn-huge { background: #444; color: white; border: none; width: 100%; padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; font-size: 1.3rem; font-weight: bold; }
        .urgent-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 8px solid #ff4d4d; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .urgent-item h3 { margin: 0 0 5px 0; font-size: 1.2rem; color: #222; }
        .urgent-item p { margin: 0; color: #666; font-size: 1rem; }
        
        #game-canvas { background: #70c5ce; display: block; margin: 0 auto; border: 4px solid #333; border-radius: 10px; max-width: 100%; touch-action: none; }
    </style>
</head>
<body>

<header>2026 Winter Master</header>

<section id="home-section" class="section active">
    <div class="main-content">
        <div class="dashboard">
            <h2 id="todayDate" style="font-size:1.2rem; margin:5px 0 2px 0;"></h2>
            <p id="statusMessage" style="font-size:1.1rem; font-weight:bold; color:#d32f2f; margin:0 0 10px 0;"></p>
            
            <div class="timeline-scroll-area">
                <div class="time-column" id="timeLabels"></div>
                <div class="timeline-container" id="todayTimeline">
                    <div id="nowLineHome" class="now-indicator"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="side-content">
        <div class="nav-stack">
            <button class="menu-btn-large" onclick="navigateTo('todo-section')">âœ… í•  ì¼ ì²´í¬í•˜ê¸°</button>
            <button class="menu-btn-large" style="background: #d32f2f;" onclick="navigateTo('urgent-section')">ğŸš¨ ê¸‰í•œ ìˆ™ì œ í™•ì¸í•˜ê¸°</button>
            <button class="menu-btn-large" onclick="navigateTo('schedule-section')">ğŸ—“ï¸ ì „ì²´ ë‹¬ë ¥ ë³´ê¸°</button>
            <a href="https://www.band.us/?referrer=https%3A%2F%2Fwww.band.us%2F" target="_blank" class="menu-btn-large" style="background: #03cf5d;">ğŸ’š ë„¤ì´ë²„ë°´ë“œ ë°”ë¡œê°€ê¸°</a>
            <a href="https://www.youtube.com/playlist?list=PL0yYc0K1-YryjgZ6AONKyBP9VjiYwTDWv" target="_blank" class="menu-btn-large">ğŸµ ë°°ê²½ ìŒì•… ì¬ìƒ (YouTube)</a>
            <button class="menu-btn-large" style="background: #f39c12;" onclick="navigateTo('game-section')">ğŸ® ë¯¸ë‹ˆ ê²Œì„ (ìµœê³ ê¸°ë¡ ì €ì¥)</button>
        </div>
    </div>
</section>

<section id="game-section" class="section">
    <button class="back-btn-huge" onclick="stopGame(); handleBackBtn();">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="dashboard" style="text-align:center;">
        <h2 style="margin-bottom:5px;">Flappy Master</h2>
        <div id="highScoreDisplay" style="font-size: 1.1rem; font-weight: bold; color: #444; margin-bottom: 10px;">ìµœê³  ê¸°ë¡: ë¡œë”© ì¤‘...</div>
        <canvas id="game-canvas" width="320" height="480"></canvas>
        <div id="game-msg" style="margin-top:15px; font-weight:bold; font-size:1.2rem; color:#d32f2f; min-height: 1.5em;"></div>
    </div>
</section>

<section id="urgent-section" class="section">
    <button class="back-btn-huge" onclick="handleBackBtn()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="dashboard">
        <h2 style="font-size:1.3rem; color:#d32f2f;">ğŸš¨ ì™„ë£Œë˜ì§€ ì•Šì€ ì§ì „ ìˆ™ì œ</h2>
        <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">ìˆ˜ì—…ì´ ì™„ì „íˆ ì¢…ë£Œëœ í›„ì— ëª©ë¡ì—ì„œ ë‹¤ìŒ ì£¼ ì¼ì •ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
        <div id="urgentList"></div>
    </div>
</section>

<section id="schedule-section" class="section">
    <button class="back-btn-huge" onclick="handleBackBtn()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="edit-controls">
        <button class="edit-btn" id="editToggleBtn" onclick="toggleEditMode()">ğŸ› ï¸ ìˆ˜ì • ëª¨ë“œ ì‹œì‘</button>
    </div>
    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; justify-content: center;">
        <button onclick="renderCalendar(1)" style="padding:15px 30px; font-size:1.2rem; font-weight:bold; border-radius:10px; border:1px solid #ccc; background:white;">1ì›”</button>
        <button onclick="renderCalendar(2)" style="padding:15px 30px; font-size:1.2rem; font-weight:bold; border-radius:10px; border:1px solid #ccc; background:white;">2ì›”</button>
        <strong id="monthTitle" style="font-size: 1.5rem; margin-left: 10px;"></strong>
    </div>
    <div class="calendar-wrapper">
        <div class="grid-container" id="calendarGrid"></div>
    </div>
</section>

<section id="todo-section" class="section">
    <button class="back-btn-huge" onclick="handleBackBtn()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="dashboard">
        <h2 style="font-size:1.2rem;">ğŸ“‹ í•  ì¼ ë¦¬ìŠ¤íŠ¸ (ì²´í¬ ì‹œ ìë™ ì‚­ì œ)</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="todoInput" style="flex:1; padding:15px; border:1px solid #ddd; border-radius:10px; font-size:1.1rem;" placeholder="í•  ì¼ ì…ë ¥">
            <button onclick="addTodo()" style="padding:0 25px; background:#222; color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold;">ì¶”ê°€</button>
        </div>
        <div id="todoList" style="font-size:1.1rem;"></div>
    </div>
</section>

<script>
    // Firebase ì´ˆê¸°í™” (ì œê³µí•˜ì‹  ì„¤ì • ê·¸ëŒ€ë¡œ ìœ ì§€)
    const firebaseConfig = {
        apiKey: "AIzaSyA5TchtCroGefUyHb7ELwim-p9FQ-wETNk",
        authDomain: "vac-828ed.firebaseapp.com",
        databaseURL: "https://vac-828ed-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "vac-828ed",
        storageBucket: "vac-828ed.firebasestorage.app",
        messagingSenderId: "575598289785",
        appId: "1:575598289785:web:c64a90aac839d5d47745a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let isEditMode = false;
    let checkData = {};
    let todoList = [];
    let currentMonth = new Date().getMonth() + 1;
    let autoAddLog = {};
    let bestScore = 0; // ìµœê³  ê¸°ë¡ ë³€ìˆ˜

    function navigateTo(id, saveHistory = true) {
        const target = document.getElementById(id);
        if (!target) return;
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        target.classList.add('active');
        if (saveHistory && history.state?.sectionId !== id) {
            history.pushState({ sectionId: id }, '', `#${id}`);
        }
        if(id === 'home-section') updateHomeDashboard();
        if(id === 'schedule-section') { isEditMode = false; currentMonth = new Date().getMonth() + 1; renderCalendar(currentMonth); }
        if(id === 'todo-section') loadTodos();
        if(id === 'urgent-section') updateUrgentList();
        if(id === 'game-section') initGame();
        window.scrollTo(0,0);
    }

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.sectionId) navigateTo(event.state.sectionId, false);
        else navigateTo('home-section', false);
    });

    function handleBackBtn() {
        if (history.state && history.state.sectionId !== 'home-section') history.back();
        else navigateTo('home-section');
    }

    // ìµœê³  ê¸°ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    db.ref('gameBestScore').on('value', (snap) => {
        bestScore = snap.val() || 0;
        const display = document.getElementById('highScoreDisplay');
        if(display) display.innerText = `ìµœê³  ê¸°ë¡: ${bestScore}ì `;
    });

    db.ref('autoAddedHistory').once('value', (snap) => {
        autoAddLog = snap.val() || {};
        db.ref('todos').on('value', (snapshot) => {
            todoList = snapshot.val() || [];
            backfillPastTodos();
            loadTodos();
        });
    });

    db.ref('checks').on('value', (snapshot) => {
        checkData = snapshot.val() || {};
        if (document.getElementById('schedule-section').classList.contains('active')) renderCalendar(currentMonth);
        updateHomeDashboard();
    });

    const baseSchedule = {
        1: [{n:'ë¬¼ë¦¬(ì†”ë£¨ì…˜)ì´ì •ìš±', s:'18:30', e:'21:30', h:18.5, dur:3, c:'phys-sol', p:'half-left'}, {n:'ë¬¼ë¦¬(ë¸Œë°¸)ì¥ì¬í•„', s:'19:20', e:'22:10', h:19.33, dur:2.8, c:'phys-br', p:'half-right'}],
        2: [{n:'í™•í†µ(ë¸Œë°¸)ì¥ì„¸ìš±T', s:'09:30', e:'12:30', h:9.5, dur:3, c:'math-br'}, {n:'í•œì»´ ì•Œê³ ë¦¬ì¦˜', s:'13:00', e:'14:50', h:13, dur:1.8, c:'algo-hc'}, {n:'í•œì»´ ì•Œê³ ë¦¬ì¦˜', s:'15:00', e:'16:50', h:15, dur:1.8, c:'algo-hc'}],
        3: [{n:'ë¬¼ë¦¬(ì†”ë£¨ì…˜)ì´ì •ìš±', s:'18:30', e:'21:30', h:18.5, dur:3, c:'phys-sol'}],
        4: [{n:'í™•í†µ(ë¸Œë°¸)ì¥ì„¸ìš±T', s:'09:30', e:'12:30', h:9.5, dur:3, c:'math-br'}, {n:'ë¯¸ì (ë¸Œë°¸)ë¥˜ìš°ì„±', s:'13:00', e:'16:00', h:13, dur:3, c:'math-ryu'}, {n:'ë¯¸ì (ì›ì†”)ê¹€ê¸°í˜„', s:'18:00', e:'22:00', h:18, dur:4, c:'math-ws'}],
        5: [{n:'ì›ì†” ì•Œê³ ë¦¬ì¦˜', s:'09:30', e:'13:30', h:9.5, dur:4, c:'algo-os'}, {n:'í•œì»´ ì•Œê³ ë¦¬ì¦˜', s:'15:00', e:'16:50', h:15, dur:1.8, c:'algo-hc'}, {n:'í•œì»´ ì•Œê³ ë¦¬ì¦˜', s:'17:00', e:'18:50', h:17, dur:1.8, c:'algo-hc'}],
        6: [{n:'í™•í†µ(ë‹¤ì›)ê¹€ì°¬ìš©', s:'09:30', e:'12:30', h:9.5, dur:3, c:'math-dw', p:'half-left'}, {n:'ë¯¸ì (ë¸Œë°¸)ë¥˜ìš°ì„±', s:'09:30', e:'12:30', h:9.5, dur:3, c:'math-ryu', p:'half-right'}, {n:'ë¬¼ë¦¬(ë¸Œë°¸)ì–‘ê¸°ì„ ', s:'16:00', e:'19:20', h:16, dur:3.33, c:'phys-yang'}]
    };

    function backfillPastTodos() {
        const start = new Date(2026, 0, 2);
        const now = new Date();
        let current = new Date(start);
        let updated = false;
        while(current <= now) {
            const m = current.getMonth() + 1;
            const d = current.getDate();
            const day = current.getDay();
            const dateKey = `${current.getFullYear()}-${m}-${d}`;
            const hhmmNow = now.getHours() * 100 + now.getMinutes();
            const isToday = (current.toDateString() === now.toDateString());
            if (m === 2 && d === 17) { current.setDate(current.getDate() + 1); continue; }
            if ((day === 1 || day === 3) && !autoAddLog[dateKey + "-lee"]) {
                if (!isToday || hhmmNow >= 1830) {
                    todoList.push({ text: `[${m}/${d}] ì´ì •ìš± ë¬¼ë¦¬ ìˆ˜ì—…ë“£ê¸°`, done: false });
                    todoList.push({ text: `[${m}/${d}] ë¬¼ë¦¬ ì´ì •ìš± ë¬¼ë¦¬ ì‹œí—˜ë³´ê¸°`, done: false });
                    autoAddLog[dateKey + "-lee"] = true; updated = true;
                }
            }
            if (m === 2 && d === 23 && !autoAddLog[dateKey + "-jangjp"]) {
                if (!isToday || hhmmNow >= 1920) {
                    todoList.push({ text: `[2/23] ì¥ì¬í•„ ë¬¼ë¦¬ ìˆ˜ì—…ë“£ê¸°`, done: false });
                    autoAddLog[dateKey + "-jangjp"] = true; updated = true;
                }
            }
            if (day === 6 && !autoAddLog[dateKey + "-kim"]) {
                if (!isToday || hhmmNow >= 930) {
                    todoList.push({ text: `[${m}/${d}] í™•í†µ ê¹€ì°¬ìš© ìˆ˜ì—…ë“£ê¸°`, done: false });
                    todoList.push({ text: `[${m}/${d}] í™•í†µ ê¹€ì°¬ìš© ì‹œí—˜ë³´ê¸°`, done: false });
                    autoAddLog[dateKey + "-kim"] = true; updated = true;
                }
            }
            if (day === 6 && !autoAddLog[dateKey + "-ryu"]) {
                if (!isToday || hhmmNow >= 930) {
                    todoList.push({ text: `[${m}/${d}] ë¯¸ì  ë¥˜ìš°ì„± ìˆ˜ì—…ë“£ê¸°`, done: false });
                    todoList.push({ text: `[${m}/${d}] ë¯¸ì  ë¥˜ìš°ì„± ì‹œí—˜ë³´ê¸°`, done: false });
                    autoAddLog[dateKey + "-ryu"] = true; updated = true;
                }
            }
            if ((day === 2 || day === 4) && !autoAddLog[dateKey + "-jang"]) {
                if (!isToday || hhmmNow >= 1230) {
                    todoList.push({ text: `[${m}/${d}] í™•í†µ ì¥ì„¸ìš± ì‹œí—˜ë³´ê¸°`, done: false });
                    autoAddLog[dateKey + "-jang"] = true; updated = true;
                }
            }
            current.setDate(current.getDate() + 1);
        }
        if (updated) { db.ref('todos').set(todoList); db.ref('autoAddedHistory').set(autoAddLog); }
    }

    function formatTime12(hStr) {
        let [h, m] = hStr.split(':'); h = parseInt(h);
        const p = h >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
        let h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `${p} ${h12}:${m}`;
    }
    function formatTimeShort(hStr) {
        let [h, m] = hStr.split(':'); h = parseInt(h);
        let h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        return `${h12}:${m}`;
    }
    function mergeSchedules(list) {
        if (!list || list.length <= 1) return list;
        let sorted = [...list].sort((a, b) => a.h - b.h);
        let merged = []; let current = sorted[0];
        for (let i = 1; i < sorted.length; i++) {
            let next = sorted[i];
            if (current.n === next.n && (next.h - (current.h + current.dur)) <= 0.5) {
                current = { ...current, e: next.e, dur: (next.h + next.dur) - current.h };
            } else { merged.push(current); current = next; }
        }
        merged.push(current); return merged;
    }
    function getDaySchedule(m, d) {
        const dateObj = new Date(2026, m - 1, d); const day = dateObj.getDay();
        let s = [];
        if (m === 1 && d === 3) s = baseSchedule[6].filter(ev => !ev.n.includes('ì–‘ê¸°ì„ '));
        else if (m === 1 && d === 1) s = [{n:'í™•í†µ(ë‹¤ì›)ê¹€ì°¬ìš©', s:'10:00', e:'13:00', h:10, dur:3, c:'math-dw'}, {n:'í™•í†µ(ë‹¤ì›)ê¹€ì°¬ìš©', s:'19:00', e:'22:00', h:19, dur:3, c:'math-dw'}];
        else if (m === 2) {
            if (d === 17) s = [];
            else if (d === 12) { s = baseSchedule[4].filter(ev => !ev.n.includes('ì¥ì„¸ìš±')); s.push({n:'í•™êµ ë“±êµ', s:'08:00', e:'15:30', h:8, dur:4.5, c:'hldy'}); }
            else if (d === 16 || d === 18) s = baseSchedule[day].filter(ev => ev.n.includes('ì´ì •ìš±'));
            else if (d === 21) s = baseSchedule[6].filter(ev => !ev.n.includes('ë¥˜ìš°ì„±'));
            else if (d === 23) {
                s = baseSchedule[day] || [];
                if (!s.some(ev => ev.n.includes('ì¥ì¬í•„'))) {
                    s.push({n:'ë¬¼ë¦¬(ë¸Œë°¸)ì¥ì¬í•„', s:'19:20', e:'22:10', h:19.33, dur:2.8, c:'phys-br'});
                }
            }
            else if (d === 28) s = baseSchedule[6].filter(ev => !ev.n.includes('ë¥˜ìš°ì„±') && !ev.n.includes('ì–‘ê¸°ì„ '));
            else s = baseSchedule[day] || [];
        } else s = baseSchedule[day] || [];
        return mergeSchedules(s);
    }

    function updateUrgentList() {
        const listEl = document.getElementById('urgentList');
        listEl.innerHTML = '';
        const now = new Date();
        const nowTime = now.getTime();
        let urgentFound = false;
        let processedClasses = new Set(); 

        for (let i = 0; i < 7; i++) {
            let futureDate = new Date(now);
            futureDate.setHours(0,0,0,0);
            futureDate.setDate(now.getDate() + i);
            let m = futureDate.getMonth() + 1;
            let d = futureDate.getDate();
            let sched = getDaySchedule(m, d);

            sched.forEach(ev => {
                if (ev.c === 'hldy' || processedClasses.has(ev.n)) return;
                
                const endHour = Math.floor(ev.h + ev.dur);
                const endMin = Math.round(((ev.h + ev.dur) % 1) * 60);
                const classEndTime = new Date(2026, m-1, d, endHour, endMin).getTime();

                if (classEndTime > nowTime) {
                    let prevInfo = findPreviousClass(ev.n, futureDate);
                    if (prevInfo) {
                        const saved = (checkData[prevInfo.dateKey] && checkData[prevInfo.dateKey][prevInfo.idx]) || { hw: false };
                        const auto = getAutoStatus(prevInfo.event, prevInfo.dateKey);
                        const isDone = auto.autoHw || saved.hw;

                        if (!isDone) {
                            urgentFound = true; processedClasses.add(ev.n);
                            let dayDiffStr = i === 0 ? "ì˜¤ëŠ˜" : `${i}ì¼ ë’¤`;
                            const item = document.createElement('div');
                            item.className = 'urgent-item';
                            item.innerHTML = `<h3>${ev.n}</h3><p>ìˆ˜ì—… ì˜ˆì •: ${dayDiffStr} (${m}/${d})</p><p style="margin-top:5px; color:#d32f2f; font-weight:bold;">ğŸ“ ë¯¸ì™„ë£Œ: ${prevInfo.m}ì›” ${prevInfo.d}ì¼ ìˆ˜ì—… ìˆ™ì œ</p>`;
                            listEl.appendChild(item);
                        }
                    }
                }
            });
        }
        if (!urgentFound) listEl.innerHTML = '<p style="text-align:center; padding:40px; color:#999;">í˜„ì¬ ë°€ë¦° ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì™„ë²½í•´ìš”! ğŸ‘</p>';
    }

    function findPreviousClass(className, baseDate) {
        for (let j = 1; j <= 14; j++) { 
            let pDate = new Date(baseDate);
            pDate.setDate(baseDate.getDate() - j);
            let pm = pDate.getMonth() + 1;
            let pd = pDate.getDate();
            let pSched = getDaySchedule(pm, pd);
            for (let k = pSched.length - 1; k >= 0; k--) {
                if (pSched[k].n === className) return { dateKey: `2026-${pm}-${pd}`, idx: k, m: pm, d: pd, event: pSched[k] };
            }
        }
        return null;
    }

    function getAutoStatus(ev, dateKey) {
        const [targetY, targetM, targetD] = dateKey.split('-').map(Number);
        const now = new Date(); const currentH = now.getHours() + now.getMinutes() / 60;
        const isPastDay = (targetY < now.getFullYear()) || (targetY === now.getFullYear() && targetM < (now.getMonth()+1)) || (targetY === now.getFullYear() && targetM === (now.getMonth()+1) && targetD < now.getDate());
        const isToday = (targetY === now.getFullYear() && targetM === (now.getMonth()+1) && targetD === now.getDate());
        const isPastTime = isPastDay || (isToday && currentH >= (ev.h + ev.dur));
        let autoHw = false, autoRev = false, hwLocked = false, revLocked = false;
        if (isPastTime) {
            if (ev.n.includes('ì›ì†” ì•Œê³ ë¦¬ì¦˜')) { autoRev = true; revLocked = true; }
            else if (ev.n.includes('í•œì»´ ì•Œê³ ë¦¬ì¦˜') || ev.n.includes('ë¯¸ì (ì›ì†”)ê¹€ê¸°í˜„')) { autoHw = true; autoRev = true; hwLocked = true; revLocked = true; }
        }
        return { autoHw, autoRev, hwLocked, revLocked };
    }

    function handleTaskClick(e, dateKey, taskIdx, ev) {
        if (!isEditMode) return;
        const auto = getAutoStatus(ev, dateKey);
        const rect = e.currentTarget.getBoundingClientRect();
        const isLeft = (e.clientX - rect.left) < rect.width / 2;
        if ((isLeft && auto.hwLocked) || (!isLeft && auto.revLocked)) return;
        let currentStatus = (checkData[dateKey] && checkData[dateKey][taskIdx]) || { hw: false, rev: false };
        if (isLeft) currentStatus.hw = !currentStatus.hw; else currentStatus.rev = !currentStatus.rev;
        db.ref(`checks/${dateKey}/${taskIdx}`).set(currentStatus);
    }

    function createEvElement(ev, dateKey, idx, isCalendar) {
        const div = document.createElement('div');
        div.className = `${isCalendar ? 'cal-ev' : 'ev'} ${ev.c} ${ev.p || ''}`;
        const unit = isCalendar ? 16 : 38;
        const top = (ev.h - 6) * unit + (isCalendar ? 24 : 0);
        div.style = `top:${top}px; height:${ev.dur * unit}px;`;
        const saved = (checkData[dateKey] && checkData[dateKey][idx]) || { hw: false, rev: false };
        const auto = getAutoStatus(ev, dateKey);
        const finalHw = auto.autoHw || saved.hw; const finalRev = auto.autoRev || saved.rev;
        if (isCalendar) div.onclick = (e) => handleTaskClick(e, dateKey, idx, ev);
        const locked = auto.hwLocked && auto.revLocked;
        div.innerHTML = `<div class="split-check-layer"><div class="hw-part ${finalHw ? 'active' : ''}"></div><div class="rev-part ${finalRev ? 'active' : ''}"></div></div><div class="ev-content"><b>${ev.n}${locked ? ' ğŸ”’' : ''}</b><span>${isCalendar ? formatTimeShort(ev.s)+'-'+formatTimeShort(ev.e) : formatTime12(ev.s)+' - '+formatTime12(ev.e)}</span></div>`;
        return div;
    }

    function renderCalendar(m) {
        currentMonth = m; const grid = document.getElementById('calendarGrid'); if(!grid) return;
        document.getElementById('monthTitle').innerText = `${m}ì›”`; grid.innerHTML = '';
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML += `<div class="day-header">${d}</div>`);
        const first = new Date(2026, m-1, 1).getDay(); const last = new Date(2026, m, 0).getDate();
        const now = new Date(); const realTodayM = now.getMonth() + 1; const realTodayD = now.getDate();
        for(let i=0; i<first; i++) grid.innerHTML += `<div class="day-cell"></div>`;
        for(let d=1; d<=last; d++) {
            const dateKey = `2026-${m}-${d}`; const dateObj = new Date(2026, m-1, d);
            const isToday = (m === realTodayM && d === realTodayD);
            const cell = document.createElement('div'); cell.className = `day-cell ${isToday ? 'is-today' : ''}`;
            cell.innerHTML = `<div class="day-num ${dateObj.getDay()===0 || (m===2 && (d===16||d===17||d===18)) ? 'is-red' : ''}">${d}</div>`;
            getDaySchedule(m, d).forEach((ev, idx) => { cell.appendChild(createEvElement(ev, dateKey, idx, true)); });
            grid.appendChild(cell);
        }
    }

    function updateHomeDashboard() {
        const now = new Date(); const m = now.getMonth() + 1; const d = now.getDate();
        const container = document.getElementById('todayTimeline'); if(!container) return;
        container.querySelectorAll('.ev').forEach(e => e.remove());
        getDaySchedule(m, d).forEach((ev, idx) => { container.appendChild(createEvElement(ev, `2026-${m}-${d}`, idx, false)); });
    }

    function updateClockAndLine() {
        const now = new Date();
        const m = now.getMonth() + 1; const d = now.getDate();
        const day = now.getDay();
        const dateStr = now.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
        const timeStr = now.toLocaleTimeString('ko-KR', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        if(document.getElementById('todayDate')) document.getElementById('todayDate').innerText = `${dateStr} ${timeStr} ì¼ì •`;
        const msgEl = document.getElementById('statusMessage');
        if (msgEl) {
            const sched = getDaySchedule(m, d);
            const nowH = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
            function getDiffStr(targetH) {
                let diffSec = Math.floor((targetH - nowH) * 3600);
                if (diffSec < 0) diffSec = 0;
                const hh = Math.floor(diffSec / 3600); const mm = Math.floor((diffSec % 3600) / 60); const ss = diffSec % 60;
                if (hh > 0) return `${hh}ì‹œê°„ ${mm}ë¶„ ${ss}ì´ˆ`;
                return `${mm}ë¶„ ${ss}ì´ˆ`;
            }
            if (nowH >= 0 && nowH < 5.5) msgEl.innerText = `ì¼ì–´ë‚˜ê¸°ê¹Œì§€ ${getDiffStr(5.5)} ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
            else {
                let currentClass = null; let nextClass = null;
                if (day === 1) { 
                    const jjp = sched.find(ev => ev.n.includes('ì¥ì¬í•„'));
                    if (jjp) {
                        if (nowH >= jjp.h && nowH < (jjp.h + jjp.dur)) currentClass = jjp;
                        else if (nowH < jjp.h) nextClass = jjp;
                    }
                }
                if (!currentClass && !nextClass) {
                    sched.forEach(ev => {
                        if (nowH >= ev.h && nowH < (ev.h + ev.dur)) currentClass = ev;
                        else if (nowH < ev.h && (!nextClass || ev.h < nextClass.h)) nextClass = ev;
                    });
                }
                if (currentClass) msgEl.innerText = `${currentClass.n} ìˆ˜ì—…ì¢…ë£Œê¹Œì§€ ${getDiffStr(currentClass.h + currentClass.dur)} ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
                else if (nextClass) msgEl.innerText = `${nextClass.n} ìˆ˜ì—…ê¹Œì§€ ${getDiffStr(nextClass.h)} ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
                else msgEl.innerText = `ì ë“¤ê¸°ê¹Œì§€ ${getDiffStr(24)} ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
            }
        }
        const h = now.getHours() + now.getMinutes() / 60 + now.getSeconds() / 3600;
        const line = document.getElementById('nowLineHome');
        if (line && h >= 6 && h <= 24) { line.style.top = (h - 6) * 38 + 'px'; line.style.display = 'block'; }
        else if(line) line.style.display = 'none';
        if (now.getSeconds() === 0) { updateHomeDashboard(); backfillPastTodos(); }
    }

    function toggleEditMode() {
        isEditMode = !isEditMode; const btn = document.getElementById('editToggleBtn');
        const section = document.getElementById('schedule-section');
        if (isEditMode) { btn.innerText = "âœ… ìˆ˜ì • ì™„ë£Œ (ì €ì¥ë¨)"; section.classList.add('edit-active'); }
        else { btn.innerText = "ğŸ› ï¸ ìˆ˜ì • ëª¨ë“œ ì‹œì‘"; section.classList.remove('edit-active'); }
    }

    function addTodo() {
        const input = document.getElementById('todoInput'); if(!input.value) return;
        db.ref('todos').set([...todoList, { text: input.value, done: false }]); input.value = '';
    }

    function loadTodos() {
        const el = document.getElementById('todoList'); if(!el) return;
        el.innerHTML = todoList.length ? '' : '<p style="color:#999; text-align:center;">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        todoList.forEach((t, i) => {
            const div = document.createElement('div'); div.style = "display:flex; align-items:center; padding:18px 0; border-bottom:1px solid #f0f0f0;";
            div.innerHTML = `<input type="checkbox" style="width:25px; height:25px; cursor:pointer;" onchange="deleteTodoImmediate(${i})"><span style="flex:1; margin:0 15px; font-size:1.2rem;">${t.text}</span>`;
            el.appendChild(div);
        });
    }

    function deleteTodoImmediate(i) { todoList.splice(i, 1); db.ref('todos').set(todoList); }

    /* GAME LOGIC (Flappy Bird) - Firebase BestScore ì—°ë™ */
    let canvas, ctx, animationId;
    let bird, pipes, score, gameOver;

    function initGame() {
        canvas = document.getElementById('game-canvas');
        ctx = canvas.getContext('2d');
        bird = { x: 50, y: 150, w: 20, h: 20, v: 0, g: 0.4, jump: -6 };
        pipes = []; score = 0; gameOver = false;
        document.getElementById('game-msg').innerText = "";
        
        canvas.onclick = () => { if(gameOver) initGame(); else bird.v = bird.jump; };
        window.onkeydown = (e) => { if(e.code === "Space") { e.preventDefault(); if(gameOver) initGame(); else bird.v = bird.jump; } };
        
        if(animationId) cancelAnimationFrame(animationId);
        gameLoop();
    }

    function stopGame() { if(animationId) cancelAnimationFrame(animationId); }

    function updateBestScore(finalScore) {
        if (finalScore > bestScore) {
            db.ref('gameBestScore').set(finalScore);
            document.getElementById('game-msg').innerText = `âœ¨ ì‹ ê¸°ë¡ ë‹¬ì„±! (${finalScore}ì )`;
        }
    }

    function gameLoop() {
        if(gameOver) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Bird
        bird.v += bird.g; bird.y += bird.v;
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(bird.x, bird.y, bird.w, bird.h);

        // Pipes
        if(pipes.length === 0 || pipes[pipes.length-1].x < canvas.width - 150) {
            let gap = 120;
            let topH = Math.random() * (canvas.height - gap - 100) + 50;
            pipes.push({ x: canvas.width, top: topH, bottom: canvas.height - topH - gap, passed: false });
        }

        pipes.forEach((p) => {
            p.x -= 2;
            ctx.fillStyle = "#2ecc71";
            ctx.fillRect(p.x, 0, 40, p.top);
            ctx.fillRect(p.x, canvas.height - p.bottom, 40, p.bottom);

            // Collision
            if(bird.x < p.x + 40 && bird.x + bird.w > p.x && (bird.y < p.top || bird.y + bird.h > canvas.height - p.bottom)) {
                gameOver = true;
                updateBestScore(score);
            }
            // Passing pipe
            if(p.x + 40 < bird.x && !p.passed) { score++; p.passed = true; }
        });

        pipes = pipes.filter(p => p.x > -40);
        if(bird.y < 0 || bird.y + bird.h > canvas.height) {
            gameOver = true;
            updateBestScore(score);
        }

        // Score UI
        ctx.fillStyle = "white"; ctx.font = "20px Bold Pretendard"; ctx.fillText("Score: " + score, 10, 30);
        
        // 99ì  ë‹¬ì„± ì²˜ë¦¬
        if(score >= 99) {
            gameOver = true;
            updateBestScore(score);
            document.getElementById('game-msg').innerText = "ğŸ† ì¶•í•˜í•©ë‹ˆë‹¤! 99ì  ë‹¬ì„±! ê³µë¶€í•˜ëŸ¬ ê°€ì„¸ìš”!";
        }

        if(gameOver) {
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText("Game Over", canvas.width/2, canvas.height/2);
            ctx.fillText("Click to Retry", canvas.width/2, canvas.height/2 + 30);
            ctx.textAlign = "start";
        }

        animationId = requestAnimationFrame(gameLoop);
    }

    window.onload = () => {
        const col = document.getElementById('timeLabels');
        for (let i = 6; i <= 24; i++) {
            const label = document.createElement('div'); label.className = 'time-label'; label.style.top = (i - 6) * 38 + 'px';
            label.innerText = i >= 12 ? (i === 12 ? 'ì˜¤í›„ 12' : `ì˜¤í›„ ${i-12}`) : `ì˜¤ì „ ${i}`; col.appendChild(label);
        }
        updateClockAndLine(); setInterval(updateClockAndLine, 1000);
        history.replaceState({ sectionId: 'home-section' }, '', '#home-section');
    };
</script>
</body>
</html>
